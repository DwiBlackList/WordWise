var y=Object.defineProperty;var b=(d,e,t)=>e in d?y(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var a=(d,e,t)=>b(d,typeof e!="symbol"?e+"":e,t);import{j as v}from"./jsplumb-C0sRuFZe.js";class S{constructor(e,t){a(this,"manager");a(this,"node");this.manager=e,this.node=t}execute(){this.manager.addNodeToCanvas(this.node)}undo(){this.manager.removeNodeFromCanvas(this.node.id)}}const m=class m{constructor(e){a(this,"jsPlumbInstance");a(this,"idCounter");a(this,"nodes");a(this,"undoStack");a(this,"redoStack");a(this,"gridSize");a(this,"nodeContainer");this.idCounter=1,this.nodeContainer=document.getElementById(e),this.nodes=new Map,this.undoStack=[],this.redoStack=[],this.gridSize=20,this.jsPlumbInstance=v.jsPlumb.getInstance(),this.initializeJsPlumb(),m.instance=this}static getInstance(){return m.instance}initializeJsPlumb(){this.jsPlumbInstance.setContainer(this.nodeContainer),this.jsPlumbInstance.importDefaults({Connector:["Flowchart",{cornerRadius:5,gap:10}],PaintStyle:{stroke:"#888",strokeWidth:2},HoverPaintStyle:{stroke:"#ac74d3",strokeWidth:3},EndpointStyle:{radius:3,fill:"#888"},ConnectorStyle:{stroke:"#888",strokeWidth:2}}),this.jsPlumbInstance.bind("connection",e=>{const t=this.nodes.get(e.sourceId),n=this.nodes.get(e.targetId);t&&n&&t.addConnection(n)}),this.jsPlumbInstance.bind("connectionDetached",e=>{const t=this.nodes.get(e.sourceId),n=this.nodes.get(e.targetId);t&&n&&t.removeConnection(n)})}generateNodeId(){return`node${this.idCounter++}`}getNodes(){return Array.from(this.nodes.values())}addNode(e){const t=new S(this,e);this.executeCommand(t)}addNodeToCanvas(e){this.nodes.set(e.id,e),this.nodeContainer.appendChild(e.element),this.makeNodeDraggable(e),this.addEndpoints(e.element,e.constructor.name)}removeNodeFromCanvas(e){const t=this.nodes.get(e);t&&(this.nodes.delete(e),this.nodeContainer.removeChild(t.element),this.jsPlumbInstance.removeAllEndpoints(t.element))}makeNodeDraggable(e){this.jsPlumbInstance.draggable(e.element,{containment:"parent",grid:[this.gridSize,this.gridSize],drag:()=>{this.jsPlumbInstance.repaintEverything()}})}addEndpoints(e,t){t!=="StartNode"&&this.jsPlumbInstance.addEndpoint(e,{anchor:"Left",isTarget:!0,paintStyle:{fill:"#2196f3"},maxConnections:-1,endpoint:["Dot",{radius:7}]}),t!=="EndNode"&&this.jsPlumbInstance.addEndpoint(e,{anchor:"Right",isSource:!0,paintStyle:{fill:"#ff9800"},maxConnections:-1,endpoint:["Dot",{radius:7}]})}executeCommand(e){e.execute(),this.undoStack.push(e),this.redoStack=[]}undo(){const e=this.undoStack.pop();e&&(e.undo(),this.redoStack.push(e))}redo(){const e=this.redoStack.pop();e&&(e.execute(),this.undoStack.push(e))}};a(m,"instance");let x=m;class p{constructor(e,t){a(this,"id");a(this,"x");a(this,"y");a(this,"connections");a(this,"element");if(new.target===p)throw new TypeError("Cannot construct Node instances directly");this.id=x.getInstance().generateNodeId(),this.x=e,this.y=t,this.connections=[],this.element=document.createElement("div"),this.element.id=this.id,this.element.className="node",this.setPosition(e,t)}setPosition(e,t){this.x=e,this.y=t,this.element.style.left=`${e}px`,this.element.style.top=`${t}px`}addConnection(e){this.connections.includes(e)||this.connections.push(e)}removeConnection(e){this.connections=this.connections.filter(t=>t!==e)}serialize(){return{id:this.id,type:this.constructor.name,x:this.x,y:this.y,connections:this.connections.map(e=>e.id)}}}class k extends p{constructor(t,n,{text:c=""}={text:""}){super(t,n);a(this,"text");this.text=c,this.element.className+=" auto-resize dialogue-node";const s=document.createElement("span");s.className="node-label",s.textContent="Dialogue",this.element.appendChild(s);const i=document.createElement("textarea");i.className="dialogue-textarea lde-textarea",i.placeholder="Enter dialogue...",i.value=c,this.element.appendChild(i),i.addEventListener("input",l=>{const o=l.target;this.text=o.value})}serialize(){return{...super.serialize(),text:this.text}}}class E extends p{constructor(t,n,{text:c=""}={text:""}){super(t,n);a(this,"text");this.text=c,this.element.className+=" auto-resize choice-node";const s=document.createElement("span");s.className="node-label",s.textContent="Player Choice",this.element.appendChild(s);const i=document.createElement("textarea");i.className="choice-textarea lde-textarea",i.placeholder="Enter dialogue...",i.value=c,this.element.appendChild(i),i.addEventListener("input",l=>{const o=l.target;this.text=o.value})}serialize(){return{...super.serialize(),text:this.text}}}class j extends p{constructor(e,t){super(e,t),this.element.className+=" start-node";const n=document.createElement("span");n.className="node-label",n.textContent="Start",this.element.appendChild(n)}}class I{constructor(e){this.convertDialogue(e)}async convertDialogue(e){const t=[],n={},c={},s={};e.forEach(o=>{n[o.id]=o,o.connections.forEach(r=>{c[r]=(c[r]||0)+1})});const i=(o,r="")=>{const u=n[o];if(c[o]>1&&!s[o]){const h=`manyToOne_${Object.keys(s).length+1}`;s[o]=h,t.push(`${r}label ${h}`)}else if(c[o]>1&&s[o]){t.push(`${r}jump ${s[o]}`);return}if(u.type==="DialogueNode")t.push(`${r}Villager: ${u.text}`),u.connections.forEach(f=>{const C=n[f];if(t.push(`${r}- ${C.text}`),C.connections.length>0){const g=C.connections[0],N=r+"	";c[g]>1&&s[g]?t.push(`${N}jump ${s[g]}`):i(g,N)}});else if(u.type==="ChoiceNode"&&u.connections.length>0){const h=u.connections[0];c[h]>1&&s[h]?t.push(`${r}jump ${s[h]}`):i(h,r)}},l=e.find(o=>o.type==="StartNode");l&&l.connections.length>0&&i(l.connections[0]),console.log(t.join(`
`)),await this.storeDialogue("../api/v1/dialogues",{dialogue_data:t.join(`
`)})}async storeDialogue(e,t){try{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return console.log("Dialogue stored successfully!"),await n.json()}catch(n){return console.error("Error:",n),null}}}document.addEventListener("DOMContentLoaded",()=>{var t,n,c,s,i;const d="node-container",e=new x(d);e.addNode(new j(50,window.innerHeight/2)),(t=document.getElementById("add-dialogue"))==null||t.addEventListener("click",()=>{e.addNode(new k(100,100))}),(n=document.getElementById("add-choice"))==null||n.addEventListener("click",()=>{new E(200,200),e.addNode(new E(200,200))}),(c=document.getElementById("export"))==null||c.addEventListener("click",()=>{const o=e.getNodes().map(r=>r.serialize());new I(o)}),(s=document.getElementById("undo"))==null||s.addEventListener("click",()=>{e.undo()}),(i=document.getElementById("redo"))==null||i.addEventListener("click",()=>{e.redo()})});
